<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Fix Contract</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Th√™m c√°c hi·ªáu ·ª©ng animation */
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }

        .animate-pulse-effect {
            animation: pulse 1.5s infinite;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
</head>
<body class="bg-gray-100 h-screen flex justify-center items-center">

<div class="app-container flex h-full w-full max-w-7xl mx-auto rounded-xl shadow-lg bg-white overflow-hidden">
    <div id="uploadPanel" class="upload-panel w-1/4 max-w-xs bg-white border-r border-gray-200 flex flex-col transition-all duration-300 transform -translate-x-full md:translate-x-0 md:static absolute h-full z-20">
        <div class="p-4 border-b border-gray-200 flex justify-between items-center">
            <h5 class="text-lg font-semibold text-gray-800">üìÇ T·∫£i l√™n</h5>
            <button class="text-gray-500 hover:text-gray-700 md:hidden" onclick="toggleUpload()">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <div class="p-4 flex-1 overflow-y-auto">
            <div class="mb-4">
                <label for="fileInput" class="block text-sm font-medium text-gray-700 mb-1">Ch·ªçn t·ªáp (PDF, DOCX...)</label>
                <input type="file" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100 cursor-pointer" id="fileInput" multiple>
            </div>
            <div class="mb-4">
                <label for="docId" class="block text-sm font-medium text-gray-700 mb-1">ID t√†i li·ªáu</label>
                <input type="text" class="form-input w-full border border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500 text-sm" id="docId" placeholder="Nh·∫≠p Document ID">
            </div>
            <div class="mb-4 relative">
                <button class="w-full bg-gray-200 text-gray-700 font-semibold py-2 rounded-md hover:bg-gray-300 transition-colors" onclick="togglePromptInput()">Th√™m g·ª£i √Ω k√®m theo</button>
                <textarea id="docPrompt" class="form-textarea w-full border border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500 text-sm mt-2 hidden" placeholder="V√≠ d·ª•: T√≥m t·∫Øt c√°c √Ω ch√≠nh" rows="3"></textarea>
            </div>
            <button class="w-full bg-blue-600 text-white font-semibold py-2 rounded-md hover:bg-blue-700 transition-colors" onclick="handleUpload()">T·∫£i l√™n</button>
        </div>
    </div>

    <div class="chat-panel flex-1 flex flex-col bg-gray-50">
        <div class="p-4 border-b border-gray-200 bg-white flex justify-between items-center sticky top-0 z-10">
            <h5 id="chatTitle" class="text-lg font-semibold text-gray-800 transition-colors">üí¨ Chat v·ªõi t√†i li·ªáu</h5>
            <div class="flex items-center gap-2">
                <button class="bg-gray-100 text-gray-700 text-sm font-medium py-1 px-3 rounded-full hover:bg-gray-200 transition-colors hidden md:block" onclick="toggleUpload()">üìÇ T·∫£i l√™n</button>
                <button class="bg-gray-100 text-gray-700 text-sm font-medium py-1 px-3 rounded-full hover:bg-gray-200 transition-colors" onclick="toggleSetting()">‚öôÔ∏è C√†i ƒë·∫∑t</button>
                <button class="text-gray-500 hover:text-gray-700 md:hidden" onclick="toggleUpload()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                    </svg>
                </button>
            </div>
        </div>

        <div id="settingBox" class="p-4 border-b border-gray-200 bg-gray-100 hidden fade-in">
            <div class="mb-4">
                <label for="sessionId" class="block text-sm font-medium text-gray-700 mb-1">ID Phi√™n</label>
                <input type="text" class="form-input w-full border border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500 text-sm" id="sessionId" placeholder="Session ID" readonly>
            </div>
            <div class="mb-4">
                <label for="contractSelect" class="block text-sm font-medium text-gray-700 mb-1">Ch·ªçn H·ª£p ƒê·ªìng</label>
                <select id="contractSelect" class="form-select w-full border border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500 text-sm"></select>
            </div>
            <div id="contractInfo" class="text-xs text-gray-500 mb-4 whitespace-pre-line"></div>
            <button class="w-full bg-green-600 text-white font-semibold py-2 rounded-md hover:bg-green-700 transition-colors" onclick="saveSettings()">üíæ L∆∞u C√†i ƒê·∫∑t</button>
        </div>

        <div id="messages" class="chat-messages p-4 flex-1 overflow-y-auto space-y-4"></div>

        <div class="chat-input p-4 border-t border-gray-200 bg-white flex items-center gap-2">
            <input type="text" id="chatInput" class="form-input flex-1 border border-gray-300 rounded-full py-2 px-4 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm" placeholder="Nh·∫≠p tin nh·∫Øn..." onkeydown="if(event.key==='Enter') handleSend()">
            <button class="bg-blue-600 text-white font-semibold w-10 h-10 rounded-full flex items-center justify-center hover:bg-blue-700 transition-colors" onclick="handleSend()">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 00.947 1.356L10 18.25l6.947 1.659a1 1 0 00.947-1.356l-7-14z" />
                </svg>
            </button>
        </div>
    </div>
</div>

<button id="startBtn" class="fixed bottom-1/2 left-1/2 -translate-x-1/2 translate-y-1/2 z-30 hidden px-8 py-4 rounded-full bg-green-500 text-white font-bold text-lg shadow-xl hover:bg-green-600 transition-all animate-pulse-effect"
        onclick="handleStart()">
    ‚ñ∂Ô∏è B·∫Øt ƒë·∫ßu Tr√≤ chuy·ªán
</button>

<script>
    (function() {
        if (sessionStorage.getItem('isLoggedIn') !== 'true') {
            window.location.href = 'login.html';
        }
    })();

    // Config cho marked.js v√† highlight.js
    marked.setOptions({
        highlight: function(code, lang) {
            try {
                return hljs.highlight(code, { language: lang }).value;
            } catch {
                return hljs.highlightAuto(code).value;
            }
        }
    });

    // Chuy·ªÉn ƒë·ªïi t·ª´ base64 sang ArrayBuffer
    function base64ToArrayBuffer(base64) {
        const binaryString = atob(base64);
        const len = binaryString.length;
        const bytes = new Uint8Array(len);
        for (let i = 0; i < len; i++) {
            bytes[i] = binaryString.charCodeAt(i);
        }
        return bytes.buffer;
    }

    // Chuy·ªÉn ƒë·ªïi PCM sang WAV
    function pcmToWav(pcmData, sampleRate) {
        const view = new DataView(new ArrayBuffer(44 + pcmData.byteLength));
        let offset = 0;

        function writeString(str) {
            for (let i = 0; i < str.length; i++) {
                view.setUint8(offset + i, str.charCodeAt(i));
            }
            offset += str.length;
        }

        function writeUint32(val) {
            view.setUint32(offset, val, true);
            offset += 4;
        }

        function writeUint16(val) {
            view.setUint16(offset, val, true);
            offset += 2;
        }

        // RIFF chunk
        writeString('RIFF');
        writeUint32(36 + pcmData.byteLength);
        writeString('WAVE');

        // fmt chunk
        writeString('fmt ');
        writeUint32(16);
        writeUint16(1); // PCM
        writeUint16(1); // Mono
        writeUint32(sampleRate);
        writeUint32(sampleRate * 2); // Byte rate
        writeUint16(2); // Block align
        writeUint16(16); // Bits per sample

        // data chunk
        writeString('data');
        writeUint32(pcmData.byteLength);

        // PCM data
        const pcmView = new Int16Array(pcmData);
        for (let i = 0; i < pcmView.length; i++) {
            view.setInt16(offset, pcmView[i], true);
            offset += 2;
        }

        return new Blob([view], { type: 'audio/wav' });
    }

    // T·∫°o ID phi√™n ng·∫´u nhi√™n khi t·∫£i trang
    function generateSessionId() {
        return 'sess-' + Math.random().toString(36).substring(2, 10);
    }

    window.onload = async function() {
        const savedSessionId = localStorage.getItem("sessionId");
        if (!savedSessionId) {
            document.getElementById("sessionId").value = generateSessionId();
        } else {
            document.getElementById("sessionId").value = savedSessionId;
        }
        const savedContractID = localStorage.getItem("contractID") || "";
        const uploadPanel = document.getElementById("uploadPanel");
        
        try {
            const res = await fetch("https://workflow.emg.edu.vn:5678/webhook/hd-list");
            const data = await res.json();
            const select = document.getElementById("contractSelect");
            select.innerHTML = "";
            
            data.contracts.forEach(c => {
                const opt = document.createElement("option");
                opt.value = c["M√£ h·ª£p ƒë·ªìng"];
                opt.textContent = `${c["M√£ h·ª£p ƒë·ªìng"]} - ${c["S·ªë l∆∞·ª£ng t√†i li·ªáu"]} t√†i li·ªáu`;
                if (c["M√£ h·ª£p ƒë·ªìng"] === savedContractID) {
                    opt.selected = true;
                    document.getElementById("contractInfo").textContent = c["C√°c H·ª£p ƒë·ªìng"];
                    document.getElementById("startBtn").style.display = "block";
                    // ·∫®n panel t·∫£i l√™n n·∫øu ƒë√£ c√≥ h·ª£p ƒë·ªìng
                    uploadPanel.classList.add("-translate-x-full", "md:static");
                }
                select.appendChild(opt);
            });

            select.addEventListener("change", function() {
                const selected = data.contracts.find(c => c["M√£ h·ª£p ƒë·ªìng"] === this.value);
                document.getElementById("contractInfo").textContent = selected["C√°c H·ª£p ƒë·ªìng"];
            });

        } catch (err) {
            console.error("‚ùå L·ªói t·∫£i danh s√°ch h·ª£p ƒë·ªìng", err);
        }
    };
    
    // Th√™m tin nh·∫Øn v√†o khung chat
    function addMessage(role, content) {
        const messagesDiv = document.getElementById("messages");
        const message = document.createElement("div");
        message.className = `message flex items-start space-x-2 ${role === 'user' ? 'justify-end' : ''} fade-in`;
        
        if (role !== 'user') {
            const avatar = document.createElement("div");
            avatar.className = "w-8 h-8 rounded-full bg-blue-500 text-white flex items-center justify-center text-xs font-bold flex-shrink-0";
            avatar.textContent = "AI";
            message.appendChild(avatar);
        }

        const bubble = document.createElement("div");
        bubble.className = `p-3 rounded-lg max-w-lg ${role === 'user' ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-900'}`;
        
        // Render markdown content
        bubble.innerHTML = marked.parse(content);

        message.appendChild(bubble);

        if (role === 'user') {
            const avatar = document.createElement("div");
            avatar.className = "w-8 h-8 rounded-full bg-gray-500 text-white flex items-center justify-center text-xs font-bold flex-shrink-0";
            avatar.textContent = "B·∫°n";
            message.appendChild(avatar);
        }
        
        messagesDiv.appendChild(message);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // Hi·ªÉn th·ªã tr·∫°ng th√°i AI ƒëang ph·∫£n h·ªìi
    function showLoadingStatus(status) {
        const chatTitle = document.getElementById("chatTitle");
        chatTitle.textContent = status;
        chatTitle.classList.add('text-gray-500');
        chatTitle.classList.remove('text-gray-800');
    }

    // ·∫®n tr·∫°ng th√°i AI ƒëang ph·∫£n h·ªìi
    function hideLoadingStatus() {
        const chatTitle = document.getElementById("chatTitle");
        chatTitle.textContent = "üí¨ Chat v·ªõi t√†i li·ªáu";
        chatTitle.classList.remove('text-gray-500');
        chatTitle.classList.add('text-gray-800');
    }

    // G·ª≠i tin nh·∫Øn
    async function handleSend() {
        const input = document.getElementById("chatInput");
        const message = input.value.trim();
        if (!message) return;

        addMessage("user", message);
        input.value = "";
        
        showLoadingStatus("ü§ñ AI ƒëang ph·∫£n h·ªìi...");

        const sessionId = localStorage.getItem("sessionId");
        const contractID = localStorage.getItem("contractID");

        try {
            const res = await fetch("https://workflow.emg.edu.vn:5678/webhook/hd-asking", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    messages: [{ role: "user", content: message }],
                    sessionId: sessionId,
                    contract_id: contractID
                })
            });
            const data = await res.json();
            const reply = data.output ? data.output : "‚ùå Kh√¥ng c√≥ d·ªØ li·ªáu tr·∫£ v·ªÅ";
            addMessage("assistant", reply);
        } catch (err) {
            addMessage("assistant", "‚ùå L·ªói server!");
            console.error(err);
        } finally {
            hideLoadingStatus();
        }
    }

    // X·ª≠ l√Ω n√∫t b·∫Øt ƒë·∫ßu
    async function handleStart() {
        document.getElementById("startBtn").style.display = "none";
        document.getElementById("messages").innerHTML = ""; // Clear chat history for new session
        showLoadingStatus("ü§ñ AI ƒëang ph·∫£n h·ªìi...");
        const sessionId = localStorage.getItem("sessionId");
        const contractID = localStorage.getItem("contractID");
        try {
            const res = await fetch("https://workflow.emg.edu.vn:5678/webhook/hd-asking", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    messages: [{ role: "user", content: "b·∫Øt ƒë·∫ßu" }],
                    sessionId: sessionId,
                    contract_id: contractID
                })
            });
            const data = await res.json();
            const reply = data.output ? data.output : "‚ùå Kh√¥ng c√≥ d·ªØ li·ªáu tr·∫£ v·ªÅ";
            addMessage("assistant", reply);
        } catch (err) {
            addMessage("assistant", "‚ùå L·ªói server!");
            console.error(err);
        } finally {
            hideLoadingStatus();
        }
    }

    // H√†m show/hide panel t·∫£i l√™n
    function toggleUpload() {
        const panel = document.getElementById("uploadPanel");
        panel.classList.toggle("-translate-x-full");
    }

    // H√†m show/hide c√†i ƒë·∫∑t
    function toggleSetting() {
        const box = document.getElementById("settingBox");
        box.classList.toggle("hidden");
    }

    // H√†m show/hide prompt input
    function togglePromptInput() {
        const input = document.getElementById("docPrompt");
        input.classList.toggle("hidden");
    }

    // **MODIFIED FUNCTION**
    // H√†m l∆∞u c√†i ƒë·∫∑t
    function saveSettings() {
        const contractID = document.getElementById("contractSelect").value;
        const newSessionId = generateSessionId(); // 1. Generate a new Session ID

        localStorage.setItem("contractID", contractID); // 2. Save the chosen Contract ID
        localStorage.setItem("sessionId", newSessionId); // 3. Save the NEW Session ID

        document.getElementById("sessionId").value = newSessionId; // 4. Update the UI with the new Session ID

        showNotification("‚úÖ ƒê√£ l∆∞u c√†i ƒë·∫∑t! Phi√™n m·ªõi ƒë√£ ƒë∆∞·ª£c t·∫°o.", "success");
        document.getElementById("settingBox").classList.add("hidden");
        document.getElementById("startBtn").style.display = "block";
        document.getElementById("messages").innerHTML = ""; // Clear previous chat messages
        
        // ·∫®n b·∫£ng t·∫£i l√™n sau khi l∆∞u c√†i ƒë·∫∑t th√†nh c√¥ng
        const uploadPanel = document.getElementById("uploadPanel");
        if (!uploadPanel.classList.contains("-translate-x-full")) {
            uploadPanel.classList.add("-translate-x-full", "md:static");
        }
    }

    // **MODIFIED FUNCTION**
    // T·∫£i l√™n nhi·ªÅu file
    async function handleUpload() {
        const fileInput = document.getElementById("fileInput");
        const docId = document.getElementById("docId").value;
        let prompt = document.getElementById("docPrompt").value.trim();

        if (!fileInput.files.length || !docId) {
            showNotification("Vui l√≤ng ch·ªçn t·ªáp v√† nh·∫≠p ID t√†i li·ªáu!", "warning");
            return;
        }
        
        if (!prompt) {
            prompt = `Vai tr√≤ & M·ª•c ti√™u Ph√¢n t√≠ch:
B·∫°n l√† Chuy√™n gia Ph√°p l√Ω H·ª£p ƒë·ªìng C·∫§P CAO c·ªßa C√îNG TY C·ªî PH·∫¶N QU·∫¢N L√ù GI√ÅO D·ª§C V√Ä ƒê·∫¶U T∆Ø E M G (PARTY B). Nhi·ªám v·ª• c·ªßa b·∫°n l√† ƒë·ªçc k·ªπ H·ª£p ƒë·ªìng/D·ªØ li·ªáu ƒë∆∞·ª£c cung c·∫•p v√† ƒë∆∞a ra m·ªôt b√°o c√°o ph√¢n t√≠ch r·ªßi ro S·∫ÆC S·∫¢O, NG·∫ÆN G·ªåN v√† CH·ªà T·∫¨P TRUNG v√†o c√°c ƒëi·ªÉm c·∫ßn ƒëi·ªÅu ch·ªânh/c·∫£nh b√°o.

Y√™u c·∫ßu B√°o c√°o R·ªßi ro (T·ªëi ƒëa 300 t·ª´):

Ph√¢n t√≠ch R·ª¶I RO CH√çNH: Ph·∫£i x√°c ƒë·ªãnh v√† n√™u r√µ c√°c r·ªßi ro.

∆Øu ti√™n 1: R·ªßi ro v·ªÅ Chi ph√≠/Thanh to√°n (ƒë∆°n v·ªã ti·ªÅn t·ªá, s·ªë ti·ªÅn, c√°ch t√≠nh).

∆Øu ti√™n 2: R·ªßi ro v·ªÅ L·ª£i √≠ch, Tr√°ch nhi·ªám, v√† B·∫£o m·∫≠t D·ªØ li·ªáu tr·ª±c ti·∫øp ƒë·ªëi v·ªõi B√™n B (EMG).

VƒÉn phong: T·ª± nhi√™n, tr·ª±c ti·∫øp, gi·ªëng nh∆∞ l·ªùi khuy√™n kh·∫©n c·∫•p t·ª´ m·ªôt chuy√™n gia n·ªôi b·ªô. Tuy·ªát ƒë·ªëi kh√¥ng li·ªát k√™ kh√¥ c·ª©ng.

Y√™u c·∫ßu Ki·ªÉm tra v√† B√°o c√°o Th√¥ng tin Ph√°p l√Ω (TUY·ªÜT ƒê·ªêI):

ƒê·ªëi chi·∫øu n·ªôi dung h·ª£p ƒë·ªìng v·ªõi d·ªØ li·ªáu chu·∫©n 100% c·ªßa EMG:

T√™n c√¥ng ty: C√îNG TY C·ªî PH·∫¶N QU·∫¢N L√ù GI√ÅO D·ª§C V√Ä ƒê·∫¶U T∆Ø E M G (ph·∫£i c√≥ kho·∫£ng c√°ch: "E M G")

T√™n vi·∫øt t·∫Øt: PARTY B: EMG EDUCATION

ƒê·ªãa ch·ªâ: 41 Nguy·ªÖn Th·ªã Minh Khai, P.S√†i G√≤n TP HCM

ƒêi·ªán tho·∫°i: (+84) 2838258612

M√£ s·ªë thu·∫ø: 0309533564

Ng∆∞·ªùi ƒë·∫°i di·ªán: B√† Nguy·ªÖn Vi·ªát H√†

Ch·ª©c v·ª•: Ph√≥ Gi√°m ƒë·ªëc

QUY T·∫ÆC HI·ªÇN TH·ªä TRONG PH·∫¢N H·ªíI (T·ªëi quan tr·ªçng):

N·∫øu SAI/THI·∫æU/GHI NH·∫¶M: B·∫ÆT BU·ªòC ph·∫£i m·ªü m·ªôt m·ª•c ri√™ng (V√≠ d·ª•: "C·∫¢NH B√ÅO: L·ªñI TH√îNG TIN PH√ÅP L√ù") v√† n√™u r√µ t·ª´ng l·ªói sai (VD: "M√£ s·ªë thu·∫ø b·ªã thi·∫øu", "T√™n c√¥ng ty vi·∫øt li·ªÅn EMG thay v√¨ E M G").

N·∫øu ƒê√öNG 100%: TUY·ªÜT ƒê·ªêI KH√îNG HI·ªÇN TH·ªä TI√äU ƒê·ªÄ, KH√îNG HI·ªÇN TH·ªä C√ÇU K·∫æT LU·∫¨N hay b·∫•t c·ª© n·ªôi dung n√†o li√™n quan ƒë·∫øn vi·ªác ki·ªÉm tra th√¥ng tin. Gi·ªØ ph·∫£n h·ªìi c√¥ ƒë·ªçng v√† ch·ªâ t·∫≠p trung v√†o ph·∫ßn R·ªßi ro Ch√≠nh.

C·∫§U TR√öC PH·∫¢N H·ªíI B·∫ÆT BU·ªòC:

Ph√¢n t√≠ch R·ªßi ro Ch√≠nh (T·ª± nhi√™n, kh√¥ng d√πng ti√™u ƒë·ªÅ list/b·∫£ng).

M·ª•c C·∫£nh b√°o L·ªói Th√¥ng tin (CH·ªà HI·ªÇN TH·ªä KHI C√ì SAI S√ìT).`;
        }

        const formData = new FormData();
        for (let file of fileInput.files) {
            formData.append("files", file);
        }
        formData.append("id", docId);
        formData.append("prompt", prompt);

        try {
            const res = await fetch("https://workflow.emg.edu.vn:5678/webhook/hd-upload", {
                method: "POST",
                body: formData
            });
            if (res.ok) {
                // 1. Logic t·ª± ƒë·ªông thi·∫øt l·∫≠p phi√™n sau khi t·∫£i l√™n th√†nh c√¥ng
                const newContractID = docId; // Doc ID l√† Contract ID m·ªõi
                const newSessionId = generateSessionId(); // T·∫°o m·ªôt Session ID m·ªõi

                // 2. T·ª± ƒë·ªông l∆∞u tr·ªØ v√†o Local Storage
                localStorage.setItem("contractID", newContractID);
                localStorage.setItem("sessionId", newSessionId);
                
                // C·∫≠p nh·∫≠t giao di·ªán c√†i ƒë·∫∑t (ƒë·ªÉ ng∆∞·ªùi d√πng th·∫•y)
                document.getElementById("sessionId").value = newSessionId;

                showNotification("‚úÖ T·∫£i l√™n th√†nh c√¥ng! Phi√™n l√†m vi·ªác m·ªõi ƒë√£ s·∫µn s√†ng.", "success");
                
                // 3. T·ª± ƒë·ªông ·∫©n Panel T·∫£i l√™n v√† hi·ªÉn th·ªã n√∫t B·∫Øt ƒë·∫ßu
                toggleUpload(); 
                document.getElementById("startBtn").style.display = "block";
                document.getElementById("messages").innerHTML = ""; // X√≥a tin nh·∫Øn c≈©

            } else {
                showNotification("‚ùå T·∫£i l√™n th·∫•t b·∫°i!", "error");
            }
        } catch (err) {
            showNotification("‚ùå L·ªói k·∫øt n·ªëi m√°y ch·ªß!", "error");
            console.error(err);
        }
    }

    // Hi·ªÉn th·ªã th√¥ng b√°o t√πy ch·ªânh (thay th·∫ø alert)
    function showNotification(message, type) {
        const appContainer = document.querySelector('.app-container');
        const notification = document.createElement('div');
        notification.className = `fixed top-5 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-lg shadow-lg text-white font-semibold transition-all duration-300 opacity-0 z-50`;
        if (type === 'success') {
            notification.classList.add('bg-green-500');
        } else if (type === 'error') {
            notification.classList.add('bg-red-500');
        } else if (type === 'warning') {
            notification.classList.add('bg-yellow-500');
        }
        notification.textContent = message;
        appContainer.appendChild(notification);
        
        setTimeout(() => {
            notification.style.opacity = '1';
        }, 100);

        setTimeout(() => {
            notification.style.opacity = '0';
            setTimeout(() => {
                notification.remove();
            }, 300);
        }, 3000);
    }
</script>

</body>
</html>