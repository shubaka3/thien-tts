<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V-Mentor AI (Merged)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        :root {
            --bg-dark: #1a1a2e;
            --primary-dark: rgba(22, 33, 62, 0.85);
            --secondary-dark: rgba(15, 52, 96, 0.9);
            --accent-color: #ff4757;
            --text-light: #f5f6fa;
            --text-muted: #a4b0be;
            --path-node-locked: #576574;
            --path-node-completed: #1dd1a1;
            --path-node-current: #ffc312;
            --path-line-color: rgba(255, 255, 255, 0.2);
            --path-line-lit-color: #ffc312;

            /* Game Colors */
            --game-accent-color: #3498db;
            --game-correct-color: #2ecc71;
            --game-incorrect-color: #e74c3c;
            --game-card-bg: #ecf0f1;
            --game-text-dark: #2c3e50;
        }

        html, body {
            height: 100%;
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            background-color: var(--bg-dark);
            color: var(--text-light);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.3); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.5); }

        /* --- Screens --- */
        .screen {
            display: none;
            height: 100%;
            width: 100%;
            overflow: hidden;
        }
        #login-screen { display: flex; } /* Show by default */

        /* --- Login Screen --- */
        #login-screen {
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(10px);
        }
        .login-box {
            background: var(--primary-dark);
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            width: 100%;
            max-width: 400px;
            text-align: center;
            border: 1px solid var(--secondary-dark);
        }

        /* --- Dashboard Screen --- */
        #dashboard-screen {
            display: none;
            flex-direction: column;
            align-items: center;
            padding: 40px;
            overflow-y: auto;
        }
        #dashboard-screen h1 {
            margin-bottom: 40px;
            text-shadow: 0 0 15px rgba(255,255,255,0.5);
        }
        .course-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 25px;
            width: 100%;
            max-width: 1200px;
        }
        .course-card {
            background: var(--primary-dark);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            border: 1px solid var(--secondary-dark);
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .course-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.5);
        }
        .course-card h4 { color: var(--text-light); }
        .course-card p { color: var(--text-muted); font-size: 0.9em; }
        .course-card.current {
            border-color: var(--path-node-current);
            box-shadow: 0 0 25px rgba(255, 195, 18, 0.4);
        }
        .course-card.current .current-tag {
            color: var(--path-node-current);
            font-weight: bold;
            font-size: 0.8em;
        }

        /* --- App Screen --- */
        #app-screen { backdrop-filter: blur(5px) brightness(0.8); }
        .main-container { display: flex; height: 100%; }
        
        /* --- Learning Path Panel (3/7 width) --- */
        .learning-path-panel {
            flex: 3;
            padding: 30px;
            position: relative;
            overflow-y: auto;
            overflow-x: hidden;
            background-size: cover;
            background-position: center;
            transition: background-image 0.5s ease-in-out;
        }
        
        #learning-path-container {
            position: relative;
            width: 100%;
            min-height: 1500px;
        }

        #progress-wave-container {
            position: absolute;
            bottom: 0; left: 0;
            width: 100%; height: 100%;
            z-index: -2;
            overflow: hidden;
        }

        #progress-wave {
            position: absolute;
            bottom: 0; left: 0;
            width: 100%;
            height: 0; /* Starts at 0, controlled by JS */
            background: linear-gradient(to top, rgba(255, 195, 18, 0.2), rgba(29, 209, 161, 0.15), transparent 70%);
            transition: height 2s cubic-bezier(0.25, 1, 0.5, 1); /* Smooth transition */
        }
        
        .path-node {
            position: absolute;
            width: 110px; height: 110px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease, filter 0.5s ease;
            border: 5px solid;
            padding: 8px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.5);
        }

        .path-node-title {
            font-size: 12px;
            font-weight: 700;
            color: white;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
        }
        
        .path-node.locked {
            background: linear-gradient(45deg, var(--path-node-locked), #3d4752);
            border-color: #2f3640;
            filter: grayscale(80%) blur(1px);
        }
        
        .path-node.completed {
            background: linear-gradient(45deg, var(--path-node-completed), #18a67c);
            border-color: #107557;
            transform: scale(1.05);
        }
        
        .path-node.completed::after {
            content: '\f00c'; /* Font Awesome check icon */
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            bottom: 0px;
            right: 0px;
            color: white;
            background: var(--path-node-completed);
            border-radius: 50%;
            padding: 5px;
            font-size: 12px;
            border: 2px solid white;
        }
        
        .path-node.current {
            background: linear-gradient(45deg, var(--path-node-current), #d6a00c);
            border-color: #c0910b;
            transform: scale(1.15);
            box-shadow: 0 0 35px var(--path-node-current);
            animation: pulse 1.8s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 20px var(--path-node-current); }
            50% { box-shadow: 0 0 40px var(--path-node-current); }
            100% { box-shadow: 0 0 20px var(--path-node-current); }
        }

        #path-svg {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: -1;
        }

        .path-line {
            stroke: var(--path-line-color);
            stroke-width: 10;
            fill: none;
            stroke-linecap: round;
            transition: stroke 1s ease, stroke-width 1s ease;
        }

        .path-line.animated {
            stroke: var(--path-line-lit-color);
            animation: draw-line 2s cubic-bezier(0.45, 0, 0.55, 1) forwards;
        }
        
        .path-line.lit {
            stroke: var(--path-node-completed);
            stroke-width: 8;
        }

        @keyframes draw-line {
            to { stroke-dashoffset: 0; }
        }
        
        /* --- Chat Panel (4/7 width) --- */
        .chat-panel {
            flex: 4;
            display: flex;
            flex-direction: column;
            background: var(--primary-dark);
            border-left: 1px solid var(--secondary-dark);
            box-shadow: -5px 0 25px rgba(0,0,0,0.3);
        }
        #side-panel { position: fixed; top: 0; right: -400px; width: 350px; height: 100%; background: var(--bg-dark); box-shadow: -10px 0 25px rgba(0,0,0,0.4); transition: right 0.4s ease-in-out; z-index: 1000; border-left: 1px solid var(--secondary-dark); display: flex; flex-direction: column; }
        #side-panel.open { right: 0; }
        .side-panel-header { padding: 10px 15px; border-bottom: 1px solid var(--secondary-dark); display: flex; justify-content: space-between; align-items: center; }
        .side-panel-body { padding: 20px; overflow-y: auto; }
        .message { display: flex; align-items: flex-end; margin-bottom: 15px; max-width: 85%;}
        .message.user { margin-left: auto; flex-direction: row-reverse; }
        .message.user .bubble { background: #0084ff; color: white; border-bottom-right-radius: 5px; }
        .message.assistant .bubble { background: var(--secondary-dark); color: var(--text-light); border-bottom-left-radius: 5px; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; margin: 0 10px; background: var(--secondary-dark); flex-shrink: 0; display:flex; align-items:center; justify-content:center; }
        .bubble { padding: 12px 18px; border-radius: 20px; word-wrap: break-word; }
        .chat-messages { flex-grow: 1; padding: 15px; overflow-y: auto; }
        .chat-input { border-top: 1px solid var(--secondary-dark); padding: 15px; display: flex; gap: 10px; background: var(--bg-dark); }
        .chat-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; border-bottom: 1px solid var(--secondary-dark); background: var(--bg-dark); }


        /* --- GAME STYLES --- */
        .game-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .game-prompt-box {
            background: var(--primary-dark);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            width: 100%;
            max-width: 450px;
            text-align: center;
            border: 1px solid var(--secondary-dark);
        }

        #edu-game-wrapper {
            width: 100%;
            max-width: 800px;
            background-color: var(--secondary-dark);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .game-header {
            padding: 15px 20px;
            background-color: rgba(0, 0, 0, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--path-line-color);
        }

        #edu-game-main-content {
            padding: 30px;
            min-height: 400px;
            position: relative;
        }

        .edu-game-container {
            display: none; /* Hidden by default */
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }
        
        .edu-game-prompt {
            font-size: 1.3em;
            text-align: center;
            color: var(--text-light);
            margin-bottom: 10px;
        }

        .edu-game-feedback {
            font-size: 1.1em;
            font-weight: bold;
            height: 25px;
            transition: color 0.3s;
        }

        .edu-game-feedback.correct { color: var(--game-correct-color); }
        .edu-game-feedback.incorrect { color: var(--game-incorrect-color); }

        /* Fill in the Blank Game Styles */
        #edu-game-fillblank-sentence {
            font-size: 1.4em;
            background: rgba(0,0,0,0.1);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        #edu-game-fillblank-input {
            width: 80%;
            padding: 12px;
            border-radius: 8px;
            border: 2px solid #bdc3c7;
            font-size: 1.2em;
            text-align: center;
            background-color: var(--bg-dark);
            color: var(--text-light);
        }
        #edu-game-fillblank-input:focus {
            outline: none;
            border-color: var(--game-accent-color);
        }

        /* Multiple Choice Game Styles */
        #edu-game-multiplechoice-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            width: 100%;
            max-width: 600px;
        }
        .edu-game-mc-option-btn {
            background-color: var(--primary-dark);
            color: var(--text-light);
            padding: 15px;
            border-radius: 8px;
            border: 2px solid var(--secondary-dark);
            font-size: 1.1em;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .edu-game-mc-option-btn:hover:not(:disabled) {
            border-color: var(--game-accent-color);
            transform: translateY(-2px);
        }
        .edu-game-mc-option-btn:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }
        .edu-game-mc-option-btn.correct {
            background-color: var(--game-correct-color);
            color: white;
            border-color: #27ae60;
        }
        .edu-game-mc-option-btn.incorrect {
            background-color: var(--game-incorrect-color);
            color: white;
            border-color: #c0392b;
        }
        #edu-game-multiplechoice-explanation {
            background: rgba(0,0,0,0.15);
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
            width: 100%;
            max-width: 600px;
            text-align: center;
            font-style: italic;
        }

        .edu-game-controls {
            display: flex;
            gap: 15px;
            height: 50px;
            align-items: center;
        }

        /* Final Score Screen */
        #edu-game-final-score-container {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: var(--secondary-dark);
            z-index: 10;
        }
        #edu-game-final-score-container h2 { font-size: 2.5em; }
        #edu-game-final-score-container p { font-size: 1.2em; }
        #edu-game-final-score { font-size: 1.5em; font-weight: bold; color: var(--game-accent-color); }

    </style>
</head>
<body>

    <div id="login-screen" class="screen">
        <div class="login-box">
             <h2><i class="fas fa-robot"></i> V-Mentor AI</h2>
             <input type="email" class="form-control mb-3" id="email" placeholder="Email" value="test1@gmail.com">
             <input type="password" class="form-control mb-3" id="password" placeholder="M·∫≠t kh·∫©u" value="123">
             <p id="login-error" class="text-danger"></p>
             <button class="btn btn-primary w-100" onclick="handleLogin()">ƒêƒÉng Nh·∫≠p</button>
        </div>
    </div>
    <!-- <button class="btn btn-sm btn-outline-danger float-end" onclick="handleLogout()"><i class="fas fa-sign-out-alt"></i></button> -->
    <div id="dashboard-screen" class="screen">
        <h1><i class="fas fa-book-open"></i> Ch·ªçn Kh√≥a H·ªçc</h1>
        <div class="course-grid" id="course-grid">
            <!-- Course cards will be injected here -->
        </div>
    </div>

    <div id="app-screen" class="screen">
        <div class="main-container">
            <div class="learning-path-panel" id="learning-path-panel">
                 <h4 id="course-title" class="mb-4 text-white" style="text-shadow: 1px 1px 5px #000;"></h4>
                 <div id="progress-wave-container"><div id="progress-wave"></div></div>
                 <div id="learning-path-container">
                     <svg id="path-svg"></svg>
                 </div>
            </div>

            <div class="chat-panel">
                 <div class="chat-header">
                     <div class="d-flex align-items-center gap-2">
                        <button class="btn btn-sm btn-outline-light" onclick="showDashboard()"><i class="fas fa-arrow-left"></i> Quay l·∫°i</button>
                        <h5><i class="fas fa-comments ms-2"></i> Tr·ª£ l√Ω AI</h5>
                     </div>
                     <div class="d-flex align-items-center gap-2">
                         <span id="user-info" class="text-muted small"></span>
                         <button class="btn btn-sm btn-outline-light" onclick="toggleSidePanel()"><i class="fas fa-cog"></i></button>
                         <button class="btn btn-sm btn-outline-danger" onclick="handleLogout()"><i class="fas fa-sign-out-alt"></i></button>
                     </div>
                 </div>
                 <div id="messages" class="chat-messages"></div>
                 <div class="chat-input">
                     <input type="text" id="chatInput" class="form-control" placeholder="Nh·∫≠p tin nh·∫Øn..." onkeydown="if(event.key === 'Enter') handleSend()">
                     <button class="btn btn-primary" onclick="handleSend()"><i class="fas fa-paper-plane"></i></button>
                 </div>
            </div>
        </div>
    </div>
    
    <div id="side-panel">
        <div class="side-panel-header">
            <h5 id="side-panel-title">C√†i ƒë·∫∑t</h5>
            <button class="btn-close btn-close-white" onclick="toggleSidePanel()"></button>
        </div>
        <div class="side-panel-body" id="settings-view">
            <div class="mb-3">
                <label class="form-label">Ch·ªçn h√¨nh n·ªÅn cho L·ªô tr√¨nh h·ªçc</label>
                <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-outline-light flex-fill" onclick="applyBackground('https://i.pinimg.com/originals/6e/1a/c9/6e1ac970530da29e7f5d4c50/14ecb983.jpg?nii=t')">V≈© tr·ª•</button>
                    <button class="btn btn-sm btn-outline-light flex-fill" onclick="applyBackground('https://i.pinimg.com/736x/fd/90/43/fd904398637aad4e7a21c002305e82b3.jpg')">Thi√™n h√†</button>
                    <button class="btn btn-sm btn-outline-light flex-fill" onclick="applyBackground('https://i.pinimg.com/736x/a4/8a/02/a48a02715970cdf15ce1cefc20596150.jpg')">C√¢y</button>
                </div>
            </div>
        </div>
    </div>

    <!-- GAME UI -->
    <div id="game-prompt-overlay" class="game-overlay" style="display: none;">
        <div class="game-prompt-box">
            <h4><i class="fas fa-gamepad"></i> Game ·∫®n!</h4>
            <p>Ph√°t hi·ªán Topic c√≥ game ·∫©n, em c√≥ mu·ªën tr·∫£i nghi·ªám kh√¥ng?</p>
            <div class="d-flex justify-content-end gap-2 mt-4">
                <button id="decline-game-btn" class="btn btn-secondary">T·ª´ ch·ªëi</button>
                <button id="accept-game-btn" class="btn btn-primary">ƒê·ªìng √Ω</button>
            </div>
        </div>
    </div>

    <div id="game-main-overlay" class="game-overlay" style="display: none;">
        <div id="edu-game-wrapper">
            <div class="game-header">
                 <h5 id="game-title"><i class="fas fa-puzzle-piece"></i> Mini Game</h5>
                 <button id="close-game-btn" class="btn-close btn-close-white"></button>
             </div>
             <main id="edu-game-main-content">
                <!-- Game 1: Fill in the Blank -->
                <div id="edu-game-container-fillblank" class="edu-game-container">
                    <p class="edu-game-prompt">ƒêi·ªÅn v√†o ch·ªó tr·ªëng v√† nh·∫•n "Ki·ªÉm Tra".</p>
                    <div id="edu-game-fillblank-sentence"></div>
                    <input type="text" id="edu-game-fillblank-input" placeholder="C√¢u tr·∫£ l·ªùi c·ªßa b·∫°n">
                    <div class="edu-game-feedback" id="edu-game-fillblank-feedback"></div>
                    <div class="edu-game-controls">
                        <button id="edu-game-fillblank-check-btn" class="btn btn-info">Ki·ªÉm Tra</button>
                    </div>
                </div>
                
                <!-- Game 2: Multiple Choice -->
                <div id="edu-game-container-multiplechoice" class="edu-game-container">
                    <p class="edu-game-prompt" id="edu-game-multiplechoice-question"></p>
                    <div id="edu-game-multiplechoice-options"></div>
                    <div class="edu-game-feedback" id="edu-game-multiplechoice-feedback"></div>
                    <div id="edu-game-multiplechoice-explanation" style="display:none;"></div>
                    <div class="edu-game-controls">
                        <button id="edu-game-multiplechoice-next-btn" class="btn btn-info" style="display:none;">Ti·∫øp theo</button>
                    </div>
                </div>
                
                <!-- Final Score Screen (shared) -->
                <div id="edu-game-final-score-container">
                    <h2>Ho√†n th√†nh!</h2>
                    <p>ƒêi·ªÉm c·ªßa b·∫°n: <span id="edu-game-final-score"></span></p>
                    <p id="edu-game-final-feedback"></p>
                    <button id="edu-game-restart-btn" class="btn btn-primary">Ch∆°i l·∫°i</button>
                </div>
            </main>
        </div>
    </div>


<script>
    // --- STATE MANAGEMENT & CONSTANTS ---
    const state = {
        userId: null, isLoggedIn: false, currentCourseId: null,
        currentProgress: 1, courses: [], topics: [], sessionFlagSent: false,
    };
    const API_BASE_URL = "https://workflow.emg.edu.vn:5678/webhook";
    const CHAT_API_URL = "https://workflow.emg.edu.vn:5678/webhook/VTV3";
    const DEFAULT_BG = 'https://i.pinimg.com/originals/6e/1a/c9/6e1ac970530da29e7f5d4c50/14ecb983.jpg?nii=t';

    // --- DOM Elements ---
    const loginScreen = document.getElementById('login-screen');
    const dashboardScreen = document.getElementById('dashboard-screen');
    const appScreen = document.getElementById('app-screen');

    // --- INITIALIZATION ---
    window.onload = function() {
        const storedUser = sessionStorage.getItem('vmentorUser');
        if (storedUser) {
            const userData = JSON.parse(storedUser);
            Object.assign(state, userData);
        }

        applyBackground(localStorage.getItem('vmentorBg') || DEFAULT_BG);

        if (state.isLoggedIn) {
            postLoginSetup();
        }
        gameController.init(); // Initialize the game controller
    };
    
    // --- API & AUTH ---
    async function apiCall(endpoint, body, method = 'POST', customUrl = null) {
        const url = customUrl || `${API_BASE_URL}/${endpoint}`;
        try {
            const response = await fetch(url, {
                method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body)
            });
            if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
            return await response.json();
        } catch (error) { console.error(`Error calling ${endpoint}:`, error); return null; }
    }

    async function handleLogin() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const loginError = document.getElementById('login-error');
        loginError.textContent = '';
        
        const response = await apiCall('VTV3-Login', { email, password });
        
        if (response && response.State) {
            state.userId = response.UserId;
            state.isLoggedIn = true;
            sessionStorage.setItem('vmentorUser', JSON.stringify({ userId: state.userId, isLoggedIn: true }));
            await postLoginSetup();
        } else {
            loginError.textContent = 'ƒêƒÉng nh·∫≠p th·∫•t b·∫°i. Vui l√≤ng th·ª≠ l·∫°i.';
        }
    }

    function handleLogout() {
        sessionStorage.clear();
        localStorage.clear();
        window.location.reload();
    }
    
    async function postLoginSetup() {
        document.getElementById('user-info').textContent = `User: ${state.userId}`;
        try {
            const courseResponse = await fetch(`${API_BASE_URL}/course-list`).then(res => res.json());
            state.courses = (courseResponse && Array.isArray(courseResponse.ids)) ? courseResponse.ids : [];
        } catch (error) { console.error("Failed to fetch course list:", error); }
        
        showDashboard();
    }
    
    // --- SCREEN NAVIGATION & UI ---
    function showDashboard() {
        loginScreen.style.display = 'none';
        appScreen.style.display = 'none';
        dashboardScreen.style.display = 'flex';
        renderCourseDashboard();
    }
    
    async function handleCourseSelection(courseId) {
        if (!courseId) return;

        const isNewSelection = state.currentCourseId !== courseId;
        localStorage.setItem('vmentorCourseId', courseId);
        state.currentCourseId = courseId;

        if (isNewSelection) {
            document.getElementById('messages').innerHTML = '';
            state.sessionFlagSent = false;
            // Reset progress state before loading new data
            state.currentProgress = 1;
            state.topics = [];
        }

        dashboardScreen.style.display = 'none';
        appScreen.style.display = 'block';

        // Show a loading indicator while fetching data
        const pathContainer = document.getElementById('learning-path-container');
        pathContainer.innerHTML = `<div class="d-flex justify-content-center align-items-center h-100 text-white">
                                       <div class="spinner-border" role="status">
                                           <span class="visually-hidden">Loading...</span>
                                       </div>
                                   </div>`;
        document.getElementById('course-title').textContent = 'ƒêang t·∫£i l·ªô tr√¨nh...';


        await loadCourseData(courseId);

        addMessage('assistant', `B·∫°n ƒëang b·∫Øt ƒë·∫ßu b√†i h·ªçc "${courseId}". h√£y c√πng h·ªçc nh√©!`);

        if (!state.sessionFlagSent) {
            sendHiddenReviewMessage();
        }
    }

    function renderCourseDashboard() {
        const grid = document.getElementById('course-grid');
        grid.innerHTML = '';
        const savedCourseId = localStorage.getItem('vmentorCourseId');

        if (savedCourseId) {
            const currentCourse = state.courses.find(c => c.id === savedCourseId);
            if (currentCourse) {
                 grid.appendChild(createCourseCard(currentCourse, true));
            }
        }

        state.courses.forEach(course => {
            if(course.id !== savedCourseId) {
                grid.appendChild(createCourseCard(course, false));
            }
        });
    }

    function createCourseCard(course, isCurrent) {
        const card = document.createElement('div');
        card.className = 'course-card';
        if (isCurrent) card.classList.add('current');
        card.onclick = () => handleCourseSelection(course.id);
        
        card.innerHTML = `
            ${isCurrent ? '<p class="current-tag"><i class="fas fa-star"></i> ƒêang h·ªçc</p>' : ''}
            <h4>${course.id}</h4>
            <p>Topics: ${course.topic}</p>
        `;
        return card;
    }
    
    // --- COURSE & LEARNING PATH (Chat View) ---
    async function loadCourseData(courseId) {
        document.getElementById('learning-path-container').innerHTML = '<svg id="path-svg"></svg>';
        const topicData = await apiCall('VTV3-TopicInCourse', { courseId });
        state.topics = topicData ? topicData.AllTopic : [];
        
        const progressData = await apiCall('VTV3-CurrenProgress', { Userid: state.userId, CoursId: courseId });
        state.currentProgress = progressData ? progressData.progress : 1;
        
        renderLearningPath();
        document.getElementById('course-title').textContent = `L·ªô tr√¨nh h·ªçc: ${courseId}`;
    }

    async function updateProgressVisuals() {
        const progressData = await apiCall('VTV3-CurrenProgress', { Userid: state.userId, CoursId: state.currentCourseId });
        if (!progressData) return;

        const oldProgress = state.currentProgress;
        const newProgress = progressData.progress;
        
        if (newProgress <= oldProgress) return; // No change or regression

        state.currentProgress = newProgress;
        
        for (let i = oldProgress + 1; i <= newProgress; i++) {
            const prevNode = document.querySelector(`.path-node[data-progress='${i-1}']`);
            const currNode = document.querySelector(`.path-node[data-progress='${i}']`);
            const pathSegment = document.getElementById(`path-${i-1}-${i}`);

            setTimeout(() => {
                if (prevNode) {
                    prevNode.classList.remove('current', 'pulse');
                    prevNode.classList.add('completed');
                }
                if (currNode) {
                    currNode.classList.remove('locked');
                    currNode.classList.add('current');
                }
                if (pathSegment) {
                    pathSegment.classList.add('animated');
                    pathSegment.addEventListener('animationend', () => {
                         pathSegment.classList.remove('animated');
                         pathSegment.classList.add('lit');
                    }, { once: true });
                }
            }, (i - oldProgress - 1) * 800);
        }

        const wave = document.getElementById('progress-wave');
        const totalTopics = state.topics.length;
        if (wave && totalTopics > 0) {
            const newHeight = (newProgress / totalTopics) * 100;
            wave.style.height = `${newHeight}%`;
        }
    }


    function renderLearningPath() {
        const container = document.getElementById('learning-path-container');
        const svg = document.getElementById('path-svg');
        container.innerHTML = ''; // Clear previous nodes
        container.appendChild(svg);
        svg.innerHTML = '';
        
        if (!state.topics || state.topics.length === 0) return;

        const pathCoords = [];
        state.topics.forEach((topic, index) => {
            const node = document.createElement('div');
            node.className = 'path-node';
            node.dataset.progress = topic.progress;
            
            const status = topic.progress < state.currentProgress ? 'completed' : (topic.progress === state.currentProgress ? 'current' : 'locked');
            node.classList.add(status);

            node.innerHTML = `<span class="path-node-title">${topic.title}</span>`;
            
            const x = 25 + (index % 2 === 0 ? 0 : 50) + (Math.random() - 0.5) * 10;
            const y = 5 + index * 13;
            node.style.left = `${x}%`;
            node.style.top = `${y}%`;

            container.appendChild(node);
            pathCoords.push({ x: x + 5.5, y: y + 5.5});
        });

        for(let i = 1; i < pathCoords.length; i++) {
             const p1 = pathCoords[i-1];
             const p2 = pathCoords[i];
             const cx = (p1.x + p2.x)/2 + (p2.x > p1.x ? -10:10);
             const cy = (p1.y + p2.y)/2;
             const pathD = `M ${p1.x}% ${p1.y}% S ${cx}% ${cy}% ${p2.x}% ${p2.y}%`;
             
             const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
             path.setAttribute('d', pathD);
             path.id = `path-${i}-${i+1}`;
             path.classList.add('path-line');
             
             if (i < state.currentProgress) {
                 path.classList.add('lit');
             }
             
             svg.appendChild(path);
             
             const length = path.getTotalLength();
             path.style.strokeDasharray = length;
             path.style.strokeDashoffset = length;
        }

        const wave = document.getElementById('progress-wave');
        const totalTopics = state.topics.length;
        if (wave && totalTopics > 0) {
            const initialHeight = (state.currentProgress / totalTopics) * 100;
            wave.style.height = `${initialHeight}%`;
        }
    }
    
    // --- CHAT LOGIC ---
    async function handleSend() {
        const input = document.getElementById("chatInput");
        const msg = input.value.trim();
        if (!msg) return;
        addMessage("user", msg);
        input.value = "";
        
        const payload = {
            messages: [{ role: "user", content: msg }],
            sessionId: state.userId, course_id: state.currentCourseId,
            user_course_Id: state.userId + "-" + state.currentCourseId
        };

        const chatResponse = await apiCall(null, payload, 'POST', CHAT_API_URL);
        
        if (!chatResponse) {
            addMessage("assistant", "C√≥ v·∫ª ch√∫ng ta ƒë√£ h·ªçc xong h·∫øt r·ªìi! em l√†m t·ªët l·∫Øm! üéâ gi·ªù ch√∫ng ta c√≥ th·ªÉ qua Lesson kh√°c nh√©");
            return;
        }

        const responseData = (Array.isArray(chatResponse) && chatResponse.length > 0) ? chatResponse[0] : chatResponse;
        
        const outputText = responseData.output || "C√≥ v·∫ª ch√∫ng ta ƒë√£ h·ªçc xong h·∫øt r·ªìi! l√†m t·ªët l·∫Øm! üéâ gi·ªù ch√∫ng ta c√≥ th·ªÉ qua Lesson kh√°c";
        addMessage("assistant", outputText);

        if (responseData.isgame && responseData.GameData) {
            setTimeout(() => {
                gameController.showPrompt(responseData.GameData, responseData.isgame);
            }, 1000);
        }
        
        await updateProgressVisuals();
    }
    
    async function sendHiddenReviewMessage() {
        if (state.sessionFlagSent) return;
        const payload = {
            messages: [{ role: "user", content: "Em ƒë√£ tr·ªü l·∫°i" }],
            sessionId: state.userId, course_id: state.currentCourseId, SessionFlag: "1",
            user_course_Id: state.userId + "-" + state.currentCourseId
        };
        const reviewResponse = await apiCall('VTV3', payload);
        if(reviewResponse?.output) addMessage("assistant", reviewResponse.output);
        state.sessionFlagSent = true;
    }

    function formatSimpleMarkdown(str) {
        return str
          .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
          .replace(/\*(.+?)\*/g, '<em>$1</em>')
          .replace(/`(.+?)`/g, '<code>$1</code>');
    }

    function addMessage(role, text) {
        const messagesBox = document.getElementById("messages");
        const msgDiv = document.createElement("div");
        msgDiv.className = `message ${role}`;
        msgDiv.innerHTML = `
            <div class="avatar">
                <i class="fas ${role === 'user' ? 'fa-user' : 'fa-robot'}"></i>
            </div>
            <div class="bubble">${formatSimpleMarkdown(text).replace(/\n/g, '<br>')}</div>
        `;
        messagesBox.appendChild(msgDiv);
        messagesBox.scrollTop = messagesBox.scrollHeight;
    }

    // --- UI CONTROLS ---
    function toggleSidePanel() { document.getElementById('side-panel').classList.toggle('open'); }
    
    function applyBackground(url) {
        if(!url) return;
        document.getElementById('learning-path-panel').style.backgroundImage = `url('${url}')`;
        localStorage.setItem('vmentorBg', url);
    }
    
    // --- GAME CONTROLLER ---
    const gameController = {
        gameData: [],
        gameType: null,
        currentIndex: 0,
        score: 0,

        // DOM elements
        promptOverlay: null,
        mainOverlay: null,
        fillBlankContainer: null,
        mcContainer: null,
        finalScoreContainer: null,

        init() {
            this.promptOverlay = document.getElementById('game-prompt-overlay');
            this.mainOverlay = document.getElementById('game-main-overlay');
            this.fillBlankContainer = document.getElementById('edu-game-container-fillblank');
            this.mcContainer = document.getElementById('edu-game-container-multiplechoice');
            this.finalScoreContainer = document.getElementById('edu-game-final-score-container');

            document.getElementById('accept-game-btn').onclick = () => this.start();
            document.getElementById('decline-game-btn').onclick = () => this.hidePrompt();
            document.getElementById('close-game-btn').onclick = () => this.end();
            document.getElementById('edu-game-fillblank-check-btn').onclick = () => this.checkFillBlank();
            document.getElementById('edu-game-fillblank-input').onkeydown = (e) => {
                if(e.key === 'Enter') this.checkFillBlank();
            };
            document.getElementById('edu-game-multiplechoice-next-btn').onclick = () => this.nextMC();
            document.getElementById('edu-game-restart-btn').onclick = () => this.start();
        },

        showPrompt(gameDataString, gameType) {
            try {
                this.gameData = JSON.parse(gameDataString);
                this.gameType = parseInt(gameType, 10);
                if (!this.gameData || this.gameData.length === 0) return;
                this.promptOverlay.style.display = 'flex';
            } catch (e) {
                console.error("Failed to parse GameData:", e);
            }
        },

        hidePrompt() {
            this.promptOverlay.style.display = 'none';
        },

        start() {
            this.hidePrompt();
            this.currentIndex = 0;
            this.score = 0;
            
            this.fillBlankContainer.style.display = 'none';
            this.mcContainer.style.display = 'none';
            this.finalScoreContainer.style.display = 'none';

            if (this.gameType === 1) { // Fill in the blank
                this.fillBlankContainer.style.display = 'flex';
                this.loadFillBlank();
            } else if (this.gameType === 2) { // Multiple choice
                this.mcContainer.style.display = 'flex';
                this.loadMultipleChoice();
            }
            this.mainOverlay.style.display = 'flex';
        },

        end() {
            this.mainOverlay.style.display = 'none';
        },

        checkCompletion() {
            if (this.currentIndex >= this.gameData.length) {
                this.showResult();
                return true;
            }
            return false;
        },

        showResult() {
            document.getElementById('edu-game-final-score').textContent = `${this.score}/${this.gameData.length}`;
            document.getElementById('edu-game-final-feedback').textContent = this.score === this.gameData.length ? "Xu·∫•t s·∫Øc!" : "C·ªë g·∫Øng h∆°n nh√©!";
            this.fillBlankContainer.style.display = 'none';
            this.mcContainer.style.display = 'none';
            this.finalScoreContainer.style.display = 'flex';
        },

        // --- Fill in the Blank Logic ---
        loadFillBlank() {
            if (this.checkCompletion()) return;
            const item = this.gameData[this.currentIndex];
            const sentenceEl = document.getElementById('edu-game-fillblank-sentence');
            const inputEl = document.getElementById('edu-game-fillblank-input');
            const feedbackEl = document.getElementById('edu-game-fillblank-feedback');
            const checkBtn = document.getElementById('edu-game-fillblank-check-btn');

            sentenceEl.textContent = item.sentence || '';
            inputEl.value = '';
            feedbackEl.textContent = '';
            inputEl.disabled = false;
            checkBtn.style.display = 'inline-block';
            inputEl.focus();
        },

        checkFillBlank() {
            const item = this.gameData[this.currentIndex];
            const inputEl = document.getElementById('edu-game-fillblank-input');
            const feedbackEl = document.getElementById('edu-game-fillblank-feedback');
            const checkBtn = document.getElementById('edu-game-fillblank-check-btn');
            
            const userAnswer = inputEl.value.trim();
            const isCorrect = userAnswer.toLowerCase() === item.answer.toLowerCase();

            if (isCorrect) {
                this.score++;
                feedbackEl.textContent = 'Ch√≠nh x√°c!';
                feedbackEl.className = 'edu-game-feedback correct';
            } else {
                feedbackEl.textContent = `Sai r·ªìi! ƒê√°p √°n l√†: ${item.answer}`;
                feedbackEl.className = 'edu-game-feedback incorrect';
            }
            
            checkBtn.style.display = 'none';
            inputEl.disabled = true;

            setTimeout(() => {
                this.currentIndex++;
                this.loadFillBlank();
            }, 2000);
        },

        // --- Multiple Choice Logic ---
        loadMultipleChoice() {
            if (this.checkCompletion()) return;
            const item = this.gameData[this.currentIndex];
            const questionEl = document.getElementById('edu-game-multiplechoice-question');
            const optionsEl = document.getElementById('edu-game-multiplechoice-options');
            
            questionEl.textContent = item.question || '';
            optionsEl.innerHTML = '';
            
            (item.options || []).forEach((option, index) => {
                const button = document.createElement('button');
                button.className = 'edu-game-mc-option-btn';
                button.textContent = option;
                button.onclick = () => this.selectAnswerMC(index, button);
                optionsEl.appendChild(button);
            });
            
            document.getElementById('edu-game-multiplechoice-feedback').textContent = '';
            document.getElementById('edu-game-multiplechoice-explanation').style.display = 'none';
            document.getElementById('edu-game-multiplechoice-next-btn').style.display = 'none';
        },
        
        selectAnswerMC(selectedIndex, selectedButton) {
            const item = this.gameData[this.currentIndex];
            const feedbackEl = document.getElementById('edu-game-multiplechoice-feedback');
            const optionsEl = document.getElementById('edu-game-multiplechoice-options');
            const explanationEl = document.getElementById('edu-game-multiplechoice-explanation');
            const nextBtn = document.getElementById('edu-game-multiplechoice-next-btn');

            const isCorrect = selectedIndex === item.answer;
            
            if (isCorrect) {
                this.score++;
                feedbackEl.textContent = 'Ch√≠nh x√°c!';
                feedbackEl.className = 'edu-game-feedback correct';
                selectedButton.classList.add('correct');
            } else {
                feedbackEl.textContent = 'Sai r·ªìi!';
                feedbackEl.className = 'edu-game-feedback incorrect';
                selectedButton.classList.add('incorrect');
                if (optionsEl.children[item.answer]) {
                    optionsEl.children[item.answer].classList.add('correct');
                }
            }
            
            if (item.explanation) {
                explanationEl.textContent = item.explanation;
                explanationEl.style.display = 'block';
            }
            
            Array.from(optionsEl.children).forEach(btn => btn.disabled = true);
            nextBtn.style.display = 'inline-block';
        },

        nextMC() {
            this.currentIndex++;
            this.loadMultipleChoice();
        }
    };

</script>
</body>
</html>
