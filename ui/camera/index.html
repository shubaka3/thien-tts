<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>PhÃ¡t SÃ³ng Trá»±c Tiáº¿p</title>
    <style>
        :root {
            --primary-color: #007bff; --danger-color: #dc3545;
            --dark-color: #333; --light-color: #f4f4f4;
        }
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            margin: 0; background-color: var(--dark-color); color: var(--light-color);
            display: flex; justify-content: center; align-items: center;
            height: 100vh; overflow: hidden;
        }
        .container {
            width: 100%; height: 100%; display: flex; flex-direction: column;
            justify-content: center; align-items: center; padding: 20px;
        }
        #setup-view { text-align: center; }
        #setup-view h1 { color: var(--primary-color); }
        #stream-name {
            width: 100%; max-width: 300px; padding: 15px; font-size: 1.2em; text-align: center;
            border: 2px solid var(--primary-color); border-radius: 8px;
            background: #444; color: white; margin-bottom: 20px;
        }
        .btn {
            padding: 15px 30px; font-size: 1.2em; border: none; border-radius: 8px;
            cursor: pointer; font-weight: bold; transition: transform 0.2s;
        }
        .btn:active { transform: scale(0.95); }
        #start-button { background-color: var(--primary-color); color: white; }
        #streaming-view {
            display: none; position: relative; width: 100%; height: 100%;
        }
        #local-video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        #controls {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 15px; align-items: center;
        }
        #status-indicator {
            background: rgba(0,0,0,0.5); padding: 10px 15px; border-radius: 20px;
        }
        #stop-button { background-color: var(--danger-color); color: white; }
    </style>
</head>
<body>

    <div id="setup-view" class="container">
        <h1>ðŸŽ¥ Táº¡o Luá»“ng PhÃ¡t SÃ³ng</h1>
        <p>Nháº­p tÃªn hoáº·c ID cho camera cá»§a báº¡n:</p>
        <input type="text" id="stream-name" placeholder="VÃ­ dá»¥: Kho_Hang_A">
        <button id="start-button" class="btn">Má»Ÿ Camera & Báº¯t Ä‘áº§u</button>
    </div>

    <div id="streaming-view" class="container">
        <video id="local-video" autoplay playsinline muted></video>
        <div id="controls">
            <div id="status-indicator">ðŸ”´ LIVE</div>
            <button id="stop-button" class="btn">Dá»«ng</button>
        </div>
    </div>

    <script>
        const setupView = document.getElementById('setup-view');
        const streamingView = document.getElementById('streaming-view');
        const startButton = document.getElementById('start-button');
        const stopButton = document.getElementById('stop-button');
        const streamNameInput = document.getElementById('stream-name');
        const videoElement = document.getElementById('local-video');
        const statusIndicator = document.getElementById('status-indicator');

        // --- Cáº¤U HÃŒNH QUAN TRá»ŒNG ---
        // THAY Äá»ŠA CHá»ˆ IP/DOMAIN Cá»¦A SERVER Báº N VÃ€O ÄÃ‚Y
        // VÃ­ dá»¥ khi test local: 'ws://192.168.1.10:8000/webrtc/ws'
        // VÃ­ dá»¥ khi host: 'wss://your-backend-domain.com/webrtc/ws'
        // DÃ²ng code má»›i Ä‘Ã£ Ä‘Æ°á»£c cáº­p nháº­t
        const WEBSOCKET_URL = 'wss://25e81c62a6c9.ngrok-free.app/stream/ws';

        let localStream = null;
        let ws = null;
        let peerConnection = null;

        const stunServers = {
            iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
        };

        async function startStreaming(streamName) {
            console.log(`Báº¯t Ä‘áº§u phÃ¡t sÃ³ng vá»›i tÃªn: ${streamName}`);

            try {
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' }, // Æ¯u tiÃªn camera sau
                    audio: true
                });
                videoElement.srcObject = localStream;
            } catch (error) {
                console.error('Lá»—i khi truy cáº­p camera:', error);
                alert('KhÃ´ng thá»ƒ truy cáº­p camera. Vui lÃ²ng cáº¥p quyá»n (qua HTTPS) vÃ  thá»­ láº¡i.');
                return;
            }

            connectWebSocket(streamName);

            statusIndicator.textContent = `ðŸ”´ LIVE: ${streamName}`;
            setupView.style.display = 'none';
            streamingView.style.display = 'flex';
        }

        function connectWebSocket(streamName) {
            const fullUrl = `${WEBSOCKET_URL}/${streamName}`;
            ws = new WebSocket(fullUrl);

            ws.onopen = () => {
                console.log(`ÄÃ£ káº¿t ná»‘i tá»›i "tá»•ng Ä‘Ã i": ${fullUrl}`);
            };

            ws.onmessage = async (event) => {
                const message = JSON.parse(event.data);
                console.log('Nháº­n Ä‘Æ°á»£c tin nháº¯n tá»« tá»•ng Ä‘Ã i:', message);

                if (message.answer) {
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(message.answer));
                } else if (message.iceCandidate) {
                    await peerConnection.addIceCandidate(new RTCIceCandidate(message.iceCandidate));
                } else if (message.type === 'viewer_joined') {
                    console.log('CÃ³ ngÆ°á»i xem má»›i, táº¡o lá»i má»i káº¿t ná»‘i...');
                    createPeerConnectionAndOffer();
                }
            };

            ws.onclose = () => {
                console.log('Máº¥t káº¿t ná»‘i vá»›i tá»•ng Ä‘Ã i WebSocket.');
                stopStreaming(); // Tá»± Ä‘á»™ng dá»«ng náº¿u máº¥t káº¿t ná»‘i
            };

            ws.onerror = (error) => {
                console.error("Lá»—i WebSocket:", error);
                alert("KhÃ´ng thá»ƒ káº¿t ná»‘i tá»›i server. Vui lÃ²ng kiá»ƒm tra láº¡i Ä‘á»‹a chá»‰ WebSocket.");
                stopStreaming();
            }
        }

        function createPeerConnectionAndOffer() {
            if (peerConnection) {
                console.log("ÄÃ£ cÃ³ káº¿t ná»‘i, Ä‘ang khá»Ÿi Ä‘á»™ng láº¡i...");
                peerConnection.close();
            }
            
            peerConnection = new RTCPeerConnection(stunServers);
            
            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    ws.send(JSON.stringify({ iceCandidate: event.candidate }));
                }
            };

            peerConnection.createOffer()
                .then(offer => peerConnection.setLocalDescription(offer))
                .then(() => {
                    ws.send(JSON.stringify({ offer: peerConnection.localDescription }));
                    console.log('ÄÃ£ gá»­i lá»i má»i (offer) qua tá»•ng Ä‘Ã i.');
                });
        }
        
        function stopStreaming() {
            if (ws) ws.close();
            if (peerConnection) peerConnection.close();
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
            videoElement.srcObject = null;
            localStream = null;
            ws = null;
            peerConnection = null;

            streamingView.style.display = 'none';
            setupView.style.display = 'flex';
            console.log('ÄÃ£ dá»«ng phÃ¡t sÃ³ng vÃ  dá»n dáº¹p.');
        }

        startButton.addEventListener('click', () => {
            const streamName = streamNameInput.value.trim();
            if (!streamName) {
                alert('Vui lÃ²ng nháº­p tÃªn cho luá»“ng phÃ¡t!');
                return;
            }
            startStreaming(streamName);
        });

        stopButton.addEventListener('click', stopStreaming);
    </script>
</body>
</html>